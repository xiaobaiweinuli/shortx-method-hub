<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShortX Method Hub - ç®¡ç†åå°</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">

<div class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-indigo-700 dark:bg-indigo-800 text-white shadow-lg sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 py-5 flex justify-between items-center">
      <h1 class="text-2xl font-bold">ShortX Method Hub Â· ç®¡ç†åå°</h1>
      <div class="flex items-center gap-6">
        <span id="adminStatus" class="hidden text-sm bg-white/20 px-3 py-1 rounded">å·²ç™»å½•</span>
        <button id="logoutBtn" class="hidden bg-red-600 hover:bg-red-700 px-5 py-2 rounded-lg transition">é€€å‡ºç™»å½•</button>
        <!-- æš—è‰²æ¨¡å¼åˆ‡æ¢ -->
        <button id="themeToggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
          <span class="dark:hidden">ğŸŒ™</span>
          <span class="hidden dark:inline">â˜€ï¸</span>
        </button>
      </div>
    </div>
  </header>

  <!-- ç™»å½•ç•Œé¢ -->
  <div id="loginPanel" class="max-w-md mx-auto mt-32 bg-white dark:bg-gray-800 p-10 rounded-2xl shadow-2xl">
    <h2 class="text-3xl font-bold text-center mb-8">ç®¡ç†å‘˜ç™»å½•</h2>
    <input type="password" id="adminKey" placeholder="è¯·è¾“å…¥ ADMIN_KEY" class="w-full px-6 py-4 rounded-xl border dark:border-gray-600 mb-6 text-lg">
    <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl text-lg font-medium transition">
      ç™»å½•
    </button>
    <p id="loginMsg" class="text-center mt-4 text-red-500"></p>
  </div>

  <!-- ç®¡ç†ä¸»ç•Œé¢ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <main id="adminPanel" class="hidden flex-1 max-w-7xl mx-auto w-full px-4 py-10">
    <!-- æœç´¢ä¸åˆ·æ–° -->
    <div class="flex flex-col sm:flex-row gap-4 mb-10">
      <input id="searchInput" type="text" placeholder="æœç´¢æ ‡é¢˜æˆ–æ ‡ç­¾..." 
             class="flex-1 px-6 py-4 rounded-xl border dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-4 focus:ring-indigo-300 text-lg"
             onkeyup="debouncedSearch()">
      <button onclick="loadMethods()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-medium transition">
        ğŸ”„ åˆ·æ–°åˆ—è¡¨
      </button>
    </div>

    <!-- æ–¹æ³•ç½‘æ ¼ -->
    <div id="methodList" class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 mb-10">
      <!-- JS åŠ¨æ€å¡«å…… -->
    </div>

    <!-- åˆ†é¡µ -->
    <div id="pagination" class="flex justify-center gap-3"></div>
  </main>
</div>

<!-- æ–¹æ³•è¯¦æƒ…æ¨¡æ€å¼¹çª— -->
<div id="detailModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
  <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-5xl w-full max-h-full overflow-y-auto">
    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-6 flex justify-between items-center">
      <h2 id="detailTitle" class="text-2xl font-bold"></h2>
      <button onclick="closeModal()" class="text-4xl hover:text-gray-500">&times;</button>
    </div>
    <div class="p-8">
      <!-- Tags ç¼–è¾‘ -->
      <div class="mb-8">
        <label class="block text-lg font-medium mb-3">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
        <input id="editTags" type="text" class="w-full px-5 py-3 rounded-xl border dark:border-gray-600 text-lg">
        <button onclick="saveTags()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition">
          ä¿å­˜æ ‡ç­¾
        </button>
      </div>

      <!-- Verified å¼€å…³ -->
      <div class="mb-8 flex items-center gap-4">
        <label class="text-lg font-medium">å·²éªŒè¯</label>
        <input id="editVerified" type="checkbox" class="w-6 h-6 rounded">
        <button onclick="saveVerified()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl transition">
          ä¿å­˜çŠ¶æ€
        </button>
      </div>

      <!-- å®Œæ•´ä»£ç  -->
      <div class="mb-8">
        <h3 class="text-xl font-bold mb-4">å®Œæ•´ä»£ç </h3>
        <pre id="detailCode" class="bg-gray-900 text-gray-100 p-6 rounded-2xl overflow-x-auto text-sm"><code></code></pre>
        <button onclick="copyFullCode()" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-4 rounded-xl w-full text-lg">
          ğŸ“‹ å¤åˆ¶å®Œæ•´ä»£ç 
        </button>
      </div>

      <!-- ç›¸ä¼¼æ–¹æ³• -->
      <div>
        <h3 class="text-xl font-bold mb-4">ç›¸ä¼¼æ–¹æ³•ï¼ˆæ±‰æ˜è·ç¦» â‰¤ 8ï¼‰</h3>
        <div id="similarList" class="grid gap-4 md:grid-cols-2"></div>
        <p id="noSimilar" class="text-gray-500 text-center py-8 hidden">æ— ç›¸ä¼¼æ–¹æ³•</p>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = '/api';
  let allMethods = [];
  let currentPage = 1;
  const PAGE_SIZE = 20;
  let currentMethodId = null;

  // ==================== ä¸»é¢˜åˆ‡æ¢ ====================
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark');
  }
  themeToggle.onclick = () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
  };

  // ==================== ç™»å½•ç›¸å…³ ====================
  async function login() {
    const key = document.getElementById('adminKey').value.trim();
    if (!key) return;
    const res = await fetch(`${API_BASE}/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key })
    });
    if (res.ok) {
      location.reload();
    } else {
      document.getElementById('loginMsg').textContent = 'å¯†é’¥é”™è¯¯';
    }
  }

  function checkLogin() {
    // é€šè¿‡å°è¯•è®¿é—®éœ€è¦æƒé™çš„æ¥å£åˆ¤æ–­æ˜¯å¦å·²ç™»å½•
    fetch(`${API_BASE}/methods`).then(res => {
      if (res.ok) {
        document.getElementById('loginPanel').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('adminStatus').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        loadMethods();
      }
    });
  }

  document.getElementById('logoutBtn').onclick = () => {
    document.cookie = 'admin_key=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
    location.reload();
  };

  // ==================== æ•°æ®åŠ è½½ä¸æ¸²æŸ“ ====================
  async function loadMethods() {
    try {
      const res = await fetch(`${API_BASE}/methods`);
      allMethods = await res.json();
      renderPage(1);
    } catch (e) {
      alert('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æ˜¯å¦è¿è¡Œ');
    }
  }

  function renderPage(page) {
    currentPage = page;
    const start = (page - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageData = allMethods.slice(start, end);

    const container = document.getElementById('methodList');
    if (pageData.length === 0) {
      container.innerHTML = '<p class="col-span-full text-center text-2xl text-gray-500">æš‚æ— æ–¹æ³•</p>';
      document.getElementById('pagination').innerHTML = '';
      return;
    }

    container.innerHTML = pageData.map(m => `
      <div onclick="showDetail(${m.id})" class="cursor-pointer bg-white dark:bg-gray-800 rounded-2xl shadow-lg hover:shadow-2xl transition p-8">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-xl font-semibold line-clamp-2 flex-1 mr-4">${escapeHtml(m.title)}</h3>
          <span class="${m.verified ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-200 text-gray-600 dark:bg-gray-700'} px-3 py-1 rounded-full text-sm">
            ${m.verified ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}
          </span>
        </div>
        <div class="mb-6">
          \( {m.tags ? m.tags.split(',').map(t => `<span class="inline-block bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-3 py-1 rounded-full mr-2 mb-2"># \){t}</span>`).join('') : '<span class="text-gray-500">æ— æ ‡ç­¾</span>'}
        </div>
        <pre class="bg-gray-100 dark:bg-gray-900 p-4 rounded-xl overflow-x-auto text-xs"><code>\( {escapeHtml(m.code.slice(0, 300))} \){m.code.length > 300 ? '...' : ''}</code></pre>
      </div>
    `).join('');

    renderPagination(Math.ceil(allMethods.length / PAGE_SIZE));
  }

  function renderPagination(totalPages) {
    const el = document.getElementById('pagination');
    let html = '';
    for (let i = 1; i <= totalPages; i++) {
      html += `<button onclick="renderPage(${i})" class="px-5 py-3 rounded-xl text-lg font-medium transition \( {i === currentPage ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}"> \){i}</button>`;
    }
    el.innerHTML = html;
  }

  // ==================== æœç´¢ ====================
  function debouncedSearch() {
    clearTimeout(window.searchTimer);
    window.searchTimer = setTimeout(search, 300);
  }

  function search() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (!q) {
      renderPage(1);
      return;
    }
    const filtered = allMethods.filter(m =>
      m.title.toLowerCase().includes(q) ||
      (m.tags && m.tags.toLowerCase().includes(q))
    );
    allMethods = filtered; // ä¸´æ—¶è¦†ç›–ç”¨äºåˆ†é¡µ
    renderPage(1);
  }

  // ==================== è¯¦æƒ…æ¨¡æ€ ====================
  async function showDetail(id) {
    const method = allMethods.find(m => m.id === id);
    if (!method) return;

    currentMethodId = id;
    document.getElementById('detailTitle').textContent = method.title;
    document.getElementById('editTags').value = method.tags || '';
    document.getElementById('editVerified').checked = method.verified === 1;
    document.querySelector('#detailCode code').textContent = method.code;

    // åŠ è½½ç›¸ä¼¼æ–¹æ³•
    await loadSimilarMethods(id);

    document.getElementById('detailModal').classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('detailModal').classList.add('hidden');
  }

  async function loadSimilarMethods(id) {
    const res = await fetch(`\( {API_BASE}/similar?id= \){id}`);
    const similar = await res.json();
    const container = document.getElementById('similarList');
    const noSimilar = document.getElementById('noSimilar');

    if (similar.length === 0) {
      container.innerHTML = '';
      noSimilar.classList.remove('hidden');
      return;
    }

    noSimilar.classList.add('hidden');
    container.innerHTML = similar.map(s => `
      <div class="bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-xl">
        <p class="font-medium">è·ç¦» ${s.distance}</p>
        <p class="text-sm mt-1">${escapeHtml(s.title)}</p>
      </div>
    `).join('');
  }

  // ä¿å­˜æ ‡ç­¾
  async function saveTags() {
    const tags = document.getElementById('editTags').value.trim();
    await fetch(`${API_BASE}/admin/update`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: currentMethodId, tags })
    });
    alert('æ ‡ç­¾å·²ä¿å­˜');
    loadMethods(); // åˆ·æ–°åˆ—è¡¨
  }

  // ä¿å­˜éªŒè¯çŠ¶æ€
  async function saveVerified() {
    const verified = document.getElementById('editVerified').checked;
    await fetch(`${API_BASE}/admin/update`, {
      method: 'POST',
      headers: 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: currentMethodId, verified })
    });
    alert('çŠ¶æ€å·²ä¿å­˜');
    loadMethods();
  }

  // å¤åˆ¶å®Œæ•´ä»£ç 
  function copyFullCode() {
    const code = document.querySelector('#detailCode code').textContent;
    navigator.clipboard.writeText(code).then(() => alert('âœ… å·²å¤åˆ¶å®Œæ•´ä»£ç ï¼'));
  }

  // HTML è½¬ä¹‰
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ==================== å¯åŠ¨ ====================
  checkLogin();
</script>

</body>
</html>